rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ======= HELPER FUNCTIONS =======

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Checks if the user is the OWNER of the organization
    function isOrgOwner(orgId) {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/organizations/$(orgId)).data.ownerId == request.auth.uid;
    }

    // Checks if the user has a specific role in the organization
    // Uses the deterministic ID: orgId_userId
    function hasOrgRole(orgId, role) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/memberships/$(orgId + "_" + request.auth.uid)) &&
        get(/databases/$(database)/documents/memberships/$(orgId + "_" + request.auth.uid)).data.role == role;
    }

    // Admin = Owner OR has ADMIN role
    function isOrgAdmin(orgId) {
      return isOrgOwner(orgId) || hasOrgRole(orgId, 'ADMIN');
    }

    // Staff = Admin OR has STAFF role
    function isOrgStaff(orgId) {
      return isOrgAdmin(orgId) || hasOrgRole(orgId, 'STAFF');
    }

    // ======= USERS =======
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isOwner(userId);
    }

    // ======= ORGANIZATIONS =======
    match /organizations/{orgId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      
      // Update: Owner or Admin
      allow update: if isOrgAdmin(orgId);
      
      // Delete: Only Owner
      allow delete: if isOwner(resource.data.ownerId);
    }

    // ======= MEMBERSHIPS =======
    // ID format: orgId_userId
    match /memberships/{membershipId} {
      // Read: User themselves OR Org Admin/Staff (to see list)
      allow read: if isOwner(resource.data.userId) || 
                     isOrgStaff(resource.data.orgId);

      // Create: Org Admin
      // Note: We verify the ID format matches the content
      // Constraint: Cannot add another OWNER (Owner is unique per Org definition)
      allow create: if isOrgAdmin(request.resource.data.orgId) && 
                       membershipId == request.resource.data.orgId + "_" + request.resource.data.userId &&
                       request.resource.data.role != 'OWNER';

      // Update: 
      // 1. Owner can update anyone (including promoting/demoting Admins)
      // 2. Admin can update Staff/Member, but NOT Owner and NOT other Admins
      // 3. Cannot change role to OWNER (transfer ownership requires special process)
      allow update: if (isOrgOwner(resource.data.orgId) && request.resource.data.role != 'OWNER') ||
                       (isOrgAdmin(resource.data.orgId) && 
                        resource.data.role != 'OWNER' && 
                        resource.data.role != 'ADMIN' &&
                        request.resource.data.role != 'OWNER' &&
                        request.resource.data.role != 'ADMIN');
      
      // Delete: 
      // 1. Owner can remove anyone
      // 2. Admin can remove Staff/Member
      // 3. User can remove themselves (leave)
      allow delete: if (isOrgOwner(resource.data.orgId)) ||
                       (isOrgAdmin(resource.data.orgId) && resource.data.role != 'OWNER' && resource.data.role != 'ADMIN') || 
                       isOwner(resource.data.userId);
    }

    // ======= ORGANIZATION INVITATIONS =======
    match /organization_invitations/{inviteId} {
      allow read: if (isAuthenticated() && resource.data.inviteeEmail == request.auth.token.email) ||
                     isOrgAdmin(resource.data.orgId);

      // Create: Admin can invite, but cannot invite as OWNER
      allow create: if isOrgAdmin(request.resource.data.orgId) && 
                       request.resource.data.role != 'OWNER';

      allow update: if (isAuthenticated() && resource.data.inviteeEmail == request.auth.token.email) ||
                       isOrgAdmin(resource.data.orgId);

      allow delete: if isOrgAdmin(resource.data.orgId);
    }

    // ======= EVENTS =======
    match /events/{eventId} {
      // allow read: if resource.data.status !== 'DRAFT';
      // Temporary full read permissions for events have been enabled.
      // Permissions will be adjusted after the DRAFT functionality is fully implemented.
      allow read: if true;
      
      // Read drafts: Org Staff only
      allow read: if isAuthenticated() && 
                     isOrgStaff(resource.data.organizerId);

      // Create: Org Admin only
      allow create: if isAuthenticated() && 
                       isOrgAdmin(request.resource.data.organizerId);

      // Update/Delete: Org Admin only
      allow update, delete: if isAuthenticated() && 
                               isOrgAdmin(resource.data.organizerId);
    }

    // ======= TICKETS =======
    match /tickets/{ticketId} {
    	allow read, update: if true;
    }
    //match /tickets/{ticketId} {
    //  allow read: if isOwner(resource.data.ownerId) || 
    //                 // Allow Org Staff to read tickets for their events (for scanning/validation)
    //                 // Note: This requires getting the Event to find the OrgId.
    //                 // Firestore rules limit depth. This might be expensive or hit limits.
    //                 // For now, keeping it restricted to Owner. Scanning is done via Cloud Functions.
    //                 false; 
    //  
    //  allow create, update, delete: if false;
    //}

    // ======= PAYMENTS =======
    match /payments/{paymentId} {
      allow read: if isOwner(resource.data.userId);
      allow create, update, delete: if false;
    }
    
    // ======= DEFAULT =======
    match /{document=**} {
      allow read, write: if false;
    }
  }
}